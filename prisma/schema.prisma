generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// =========================
/// Usuarios y Autenticación
/// =========================
model User {
  id            String          @id @default(uuid()) @map("user_id")
  walletAddress String          @unique @map("wallet_address")
  role          UserRole        @default(user) @map("role")
  createdAt     DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  nickname      String?
  passports     Passport[]
  scans         Scan[]
  proofs        ActivityProof[]

  @@map("Users")
}

/// =========================
/// Gestión del Evento
/// =========================
model Event {
  id          String     @id @default(uuid()) @map("event_id")
  name        String
  description String
  startDate   DateTime   @map("start_date") @db.Timestamptz(6)
  endDate     DateTime   @map("end_date") @db.Timestamptz(6)
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  activities  Activity[]
  nfcTags     NFC[]      @relation("EventToNFC")
  passports   Passport[]
  sponsors    Sponsor[]

  @@map("Events")
}

model Sponsor {
  id          String     @id @default(uuid()) @map("sponsor_id")
  eventId     String     @map("event_id")
  name        String
  description String
  activities  Activity[]
  nfcTags     NFC[]      @relation("SponsorToNFC")
  event       Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("Sponsors")
}

model Activity {
  id               String             @id @default(uuid()) @map("activity_id")
  eventId          String             @map("event_id")
  sponsorId        String?            @map("sponsor_id")
  name             String
  description      String
  numOfTokens      Int                @default(0) @map("num_of_tokens")
  createdAt        DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  // Campos para validación manual
  validationType   String             @default("scan") @map("validation_type") // "scan" | "manual" | "auto_transaction" | "auto_referral_code"
  requiresProof    Boolean            @default(false) @map("requires_proof")
  proofType        String?            @map("proof_type") // "text" | "image" | "both" | "transaction" | "referral"
  proofPrompt      String?            @map("proof_prompt") // Instrucciones para el usuario
  // Campos para validación de transacciones
  transactionPrompt String?           @map("transaction_prompt") // Instrucciones específicas para transacciones
  // Campos para validación de referidos
  referralPrompt   String?            @map("referral_prompt") // Instrucciones específicas para referidos
  // Campos para validación on-chain
  onChainValidationType String?       @map("on_chain_validation_type") // "usdc_transfer" | "cashback_event" | "token_transfer" | null
  validationConfig      Json?         @map("validation_config") // Configuración flexible: { minAmount: 25, decimals: 6, tokenAddresses: [...] }
  // Mensaje personalizado de éxito
  successMessage        String?       @map("success_message") // Mensaje que se muestra cuando la actividad es completada
  event            Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  sponsor          Sponsor?           @relation(fields: [sponsorId], references: [id])
  nfcTags          NFC[]
  activities       PassportActivity[]
  proofs           ActivityProof[]

  @@index([eventId])
  @@index([sponsorId])
  @@map("Activities")
}

/// =========================
/// Pasaporte Digital
/// =========================
model Passport {
  id         String             @id @default(uuid()) @map("passport_id")
  userId     String             @map("user_id")
  eventId    String             @map("event_id")
  progress   Int                @default(0)
  createdAt  DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  activities PassportActivity[]
  proofs     ActivityProof[]
  event      Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([eventId])
  @@map("Passports")
}

model PassportActivity {
  passportId     String                 @map("passport_id")
  activityId     String                 @map("activity_id")
  status         PassportActivityStatus @default(pending)
  timestamp      DateTime               @default(now()) @db.Timestamptz(6)
  // Nuevos campos para validación
  proofId        String?                @map("proof_id")
  requiresProof  Boolean                @default(false) @map("requires_proof")
  activity       Activity               @relation(fields: [activityId], references: [id], onDelete: Cascade)
  passport       Passport               @relation(fields: [passportId], references: [id], onDelete: Cascade)
  proof          ActivityProof?         @relation(fields: [proofId], references: [id], onDelete: SetNull)

  @@id([passportId, activityId])
  @@index([activityId])
  @@index([proofId])
  @@map("PassportActivities")
}

/// =========================
/// Interacción con Merch y Escaneo NFC
/// =========================
model NFC {
  id         String    @id @default(uuid()) @map("nfc_id")
  uuid       String    @unique
  eventId    String    @map("event_id")
  sponsorId  String?   @map("sponsor_id")
  activityId String    @map("activity_id")
  status     NFCStatus @default(available)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  activity   Activity  @relation(fields: [activityId], references: [id])
  event      Event     @relation("EventToNFC", fields: [eventId], references: [id], onDelete: Cascade)
  sponsor    Sponsor?  @relation("SponsorToNFC", fields: [sponsorId], references: [id])
  scans      Scan[]

  @@index([eventId])
  @@index([sponsorId])
  @@index([activityId])
  @@map("NFCs")
}

model Scan {
  id        String   @id @default(uuid()) @map("scan_id")
  userId    String   @map("user_id")
  nfcId     String   @map("nfc_id")
  timestamp DateTime @default(now()) @db.Timestamptz(6)
  isValid   Boolean  @default(true) @map("is_valid")
  nfc       NFC      @relation(fields: [nfcId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, nfcId])
  @@index([nfcId])
  @@map("Scans")
}

/// =========================
/// Tienda de Productos
/// =========================
model Product {
  id          String     @id @default(uuid()) @map("product_id")
  title       String
  description String
  price       Int        @map("price") // Precio en tokens SWAG
  imageUrl    String?    @map("image_url")
  isAvailable Boolean    @default(true) @map("is_available")
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)
  purchases   Purchase[]

  @@map("Products")
}

model Purchase {
  id            String   @id @default(uuid()) @map("purchase_id")
  productId     String   @map("product_id")
  walletAddress String   @map("wallet_address") // Dirección de la wallet del comprador
  productTitle  String   @map("product_title") // Guardamos el título del producto al momento de la compra
  price         Int      @map("price") // Precio pagado en tokens SWAG
  txHash        String?  @map("tx_hash") // Hash de la transacción on-chain
  status        String   @default("completed") @map("status") // completed, pending, failed
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([walletAddress])
  @@index([productId])
  @@map("Purchases")
}

/// =========================
/// Sistema de Validación Manual
/// =========================
model ActivityProof {
  id              String                @id @default(uuid()) @map("proof_id")
  userId          String                @map("user_id")
  activityId      String                @map("activity_id")
  passportId      String                @map("passport_id")
  // Evidencia enviada
  proofType       String                @map("proof_type") // "text" | "image" | "transaction" | "referral"
  textProof       String?               @map("text_proof")
  imageUrl        String?               @map("image_url")
  transactionUrl  String?               @map("transaction_url") // URL completo de Scrollscan
  transactionHash String?               @map("transaction_hash") // Hash extraído de la URL
  referralUrl     String?               @map("referral_url") // URL del referido
  referralCode    String?               @map("referral_code") // Código extraído del JSON
  // Validación
  status          ActivityProofStatus   @default(pending)
  validatedBy     String?               @map("validated_by")
  validatedAt     DateTime?             @map("validated_at") @db.Timestamptz(6)
  rejectionReason String?               @map("rejection_reason")
  // Tokens
  tokensAwarded   Int                   @default(0) @map("tokens_awarded")
  rewardTxHash    String?               @map("reward_tx_hash") // Hash de la tx de recompensa
  createdAt       DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  user              User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  activity          Activity               @relation(fields: [activityId], references: [id], onDelete: Cascade)
  passport          Passport               @relation(fields: [passportId], references: [id], onDelete: Cascade)
  passportActivity  PassportActivity[]

  @@unique([userId, activityId, passportId])
  @@index([status])
  @@index([activityId])
  @@map("ActivityProofs")
}

/// =========================
/// Enums
/// =========================
enum PassportActivityStatus {
  pending
  completed
}

enum NFCStatus {
  available
  scanned
}

enum UserRole {
  user
  admin
}

enum ActivityProofStatus {
  pending
  approved
  rejected
}
